<!doctype html>
<html lang="pt">
<head>
    <meta charset="utf-8">
    <title>Googol - Motor de Pesquisa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #1b1b1b, #1c1c1c, #171717);
            --glass-bg: rgba(34, 34, 34, 0.8);
            --accent: #22c55e;
            --accent-soft: rgba(34, 197, 94, 0.15);
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --border-subtle: rgba(148, 163, 184, 0.3);
            --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.9);
            --radius-xl: 18px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            display: flex;
            align-items: stretch;
            justify-content: center;
        }

        .page-shell {
            width: 100%;
            max-width: 1240px;
            padding: 32px 16px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (min-width: 992px) {
            .page-shell {
                padding: 40px 24px;
            }
        }

        .top-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-logo {
           width: 64px;
            height: 64px;
            border-radius: 20px;
            background-image: url("/img/logo_bw_circular.png");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .brand-text-main {
            font-weight: 700;
            letter-spacing: 0.08em;
            font-size: 1.1rem;
        }

        .brand-text-sub {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .badge-pill {
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            padding: 4px 10px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .badge-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
        }

        .main-layout {
            display: grid;
            grid-template-columns: minmax(0, 2.4fr) minmax(0, 1fr);
            gap: 20px;
            align-items: flex-start;
        }

        @media (max-width: 991px) {
            .main-layout {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .search-panel {
            background: var(--glass-bg);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(148, 163, 184, 0.28);
            padding: 22px 22px 18px;
            backdrop-filter: blur(22px);
        }

        .search-header {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 16px;
        }

        .search-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .search-title h1 {
            font-size: 1.1rem;
            margin: 0;
            font-weight: 600;
        }

        .search-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .search-chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            font-size: 0.7rem;
        }

        .search-chip {
            padding: 4px 10px;
            border-radius: 999px;
            background-color: rgba(148, 163, 184, 0.12);
            color: var(--text-muted);
        }

        .search-main {
            margin-top: 4px;
            margin-bottom: 8px;
        }

        .search-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 999px;
            padding: 4px 6px 4px 14px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            background-color: rgba(15, 23, 42, 0.9);
        }

        .search-input-wrapper:focus-within {
            border-color: #22c55e;
            box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35);
        }

        .search-icon {
            font-size: 0.95rem;
            color: var(--text-muted);
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            color: var(--text-main);
            font-size: 0.95rem;
        }

        .search-input::placeholder {
            color: #6b7280;
        }

        .search-button-main {
            border-radius: 999px;
            border: none;
            padding: 8px 18px;
            font-size: 0.85rem;
            font-weight: 500;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #020617;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.08s ease, box-shadow 0.08s ease;
            white-space: nowrap;
        }

        .search-button-main:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.35);
        }

        .search-button-main span.icon {
            font-size: 1rem;
        }

        .search-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-ghost {
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background-color: rgba(15, 23, 42, 0.9);
            color: var(--text-muted);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-ghost .dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #f97316;
        }

        .btn-ghost.ai .dot {
            background: #38bdf8;
        }

        .btn-ghost:hover {
            background-color: rgba(30, 64, 175, 0.4);
            color: #e5e7eb;
        }

        .divider-soft {
            margin: 12px 0 10px;
            border-top: 1px solid rgba(148, 163, 184, 0.24);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .results-count {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .results-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .result-card {
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(30, 64, 175, 0.45);
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.05), rgba(15, 23, 42, 1));
            transition: border-color 0.12s ease, transform 0.08s ease, background 0.12s ease;
        }

        .result-card:hover {
            border-color: rgba(56, 189, 248, 0.9);
            transform: translateY(-1px);
            background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.08), rgba(15, 23, 42, 1));
        }

        .result-title-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: baseline;
        }

        .result-title {
            font-size: 0.95rem;
            font-weight: 500;
            margin: 0 0 2px;
            color: #e5e7eb;
        }

        .result-score {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .result-url {
            font-size: 0.75rem;
            color: #353635;
            word-break: break-all;
        }

        .result-snippet {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .result-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .result-meta a {
            color: #38bdf8;
            text-decoration: none;
        }

        .result-meta a:hover {
            text-decoration: underline;
        }

        .results-empty {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .pagination-wrap {
            margin-top: 10px;
        }

        .pagination-sm .page-link {
            background-color: rgba(15, 23, 42, 0.9);
            border-color: rgba(148, 163, 184, 0.3);
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .pagination-sm .page-link:hover {
            background-color: rgba(37, 99, 235, 0.4);
            color: #e5e7eb;
        }

        .pagination-sm .page-item.active .page-link {
            background-color: #2563eb;
            border-color: #2563eb;
            color: white;
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .side-card {
            background: rgba(15, 23, 42, 0.75);
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.26);
            padding: 14px 14px 12px;
            backdrop-filter: blur(18px);
        }

        .side-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.09em;
            color: #a5b4fc;
            margin-bottom: 8px;
        }

        .side-list {
            list-style: none;
            margin: 0;
            padding-left: 0;
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        .side-list li + li {
            margin-top: 4px;
        }

        .stat-number {
            font-weight: 600;
            color: #e5e7eb;
        }

        ol.side-list {
            counter-reset: topq;
        }

        ol.side-list li {
            counter-increment: topq;
            position: relative;
            padding-left: 18px;
        }

        ol.side-list li::before {
            content: counter(topq) ".";
            position: absolute;
            left: 0;
            top: 0;
            color: #4ade80;
        }

        .side-footer {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
    </style>
</head>
<body>
<div class="page-shell">

    <!-- Top bar -->
    <header class="top-nav">
        <div class="brand">
            <div class="brand-logo"></div>
            <div>
                <div class="brand-text-main">GOOGOL</div>
                <div class="brand-text-sub">Distributed search · Meta 2</div>
            </div>
        </div>
        <div class="top-nav-right">
            <div class="badge-pill">
                <span class="badge-dot"></span>
                <span>Cluster online</span>
            </div>
            <span>SD · 2025/26</span>
        </div>
    </header>

    <!-- Grid: main search + sidebar -->
    <main class="main-layout">

        <!-- SEARCH + RESULTS PANEL -->
        <section class="search-panel">

            <!-- Header -->
            <div class="search-header">
                <div class="search-title">
                    <h1>Explora a web indexada pelo teu cluster</h1>
                    <span class="search-subtitle d-none d-md-inline">
                        Gateway · Barrels · Downloaders em tempo real
                    </span>
                </div>
                <div class="search-chip-row">
                    <span class="search-chip">Multicast fiável</span>
                    <span class="search-chip">Índice invertido</span>
                    <span class="search-chip">RMI · Java</span>
                    <span class="search-chip">Meta 2</span>
                </div>
            </div>

            <!-- Search box -->
            <div class="search-main">
                <form id="search-form"
                      class="d-flex align-items-center gap-2"
                      method="get"
                      action="/search"
                      th:action="@{/search}">
                    <div class="search-input-wrapper">
                        <span class="search-icon">⌕</span>
                        <input type="text"
                               class="search-input"
                               name="q"
                               th:value="${query}"
                               placeholder="O que queres procurar?"
                               required>
                    </div>
                    <button type="submit" class="search-button-main">
                        <span class="icon">↵</span>
                        <span>Pesquisar</span>
                    </button>
                </form>

                <div class="search-actions">
                    <form id="hn-form" method="post"
                          action="/search/hacker-news"
                          th:action="@{/search/hacker-news}">
                        <input type="hidden" name="q" th:value="${query}">
                        <button class="btn-ghost" type="submit">
                            <span class="dot"></span>
                            <span>Indexar top stories do Hacker News</span>
                        </button>
                    </form>

                    <form id="ai-form" method="post"
                          action="/search/analysis"
                          th:action="@{/search/analysis}">
                        <input type="hidden" name="q" th:value="${query}">
                        <button class="btn-ghost ai" type="submit">
                            <span class="dot"></span>
                            <span>Análise da pesquisa com IA</span>
                        </button>
                    </form>
                </div>
            </div>

            <hr class="divider-soft">

            <!-- Index new URL -->
            <section>
                <form id="index-form"
                      class="row g-2 align-items-center"
                      method="post"
                      action="/index"
                      th:action="@{/index}">
                    <div class="col-md-9">
                        <input type="url"
                               class="form-control form-control-sm"
                               name="url"
                               placeholder="Adicionar novo URL ao sistema (https://...)"
                               required
                               style="background-color: rgba(15,23,42,0.9); border-color: rgba(148,163,184,0.5); color: var(--text-main);">
                    </div>
                    <div class="col-md-3 d-grid">
                        <button type="submit" class="btn btn-sm btn-outline-success">
                            Adicionar à fila
                        </button>
                    </div>
                </form>
            </section>

            <hr class="divider-soft">

            <!-- Results -->
            <section>
                <div class="results-header">
                    <div class="results-count"
                         th:if="${totalResults != null}"
                         th:text="${totalResults} + ' resultados encontrados'">
                        Não há resultados ainda.
                    </div>
                    <div class="results-count"
                         th:if="${query != null}">
                        <span th:text="'Consulta: «' + ${query} + '»'"></span>
                    </div>
                </div>

                <!-- Empty state -->
                <div th:if="${results == null or #lists.isEmpty(results)}">
                    <p class="results-empty">
                        Faz uma pesquisa ou adiciona URLs para começares a ver o teu próprio motor de pesquisa distribuído a funcionar.
                    </p>
                </div>

                <!-- Results list -->
                <div class="results-list"
                     th:if="${results != null and !#lists.isEmpty(results)}">
                    <a href="#"
                       class="result-card text-decoration-none"
                       th:each="r : ${results}"
                       th:href="${r.url}">
                        <div class="result-title-row">
                            <h2 class="result-title" th:text="${r.title}">Título da página</h2>
                            <span class="result-score"
                                    th:text="'Score: ' + ${r.relevance}">
                                Score: 0
                            </span>
                        </div>
                        <div class="result-url"
                             th:text="${r.url}">
                            https://exemplo.com/pagina
                        </div>
                        <p class="result-snippet"
                           th:text="${r.snippet}">
                            Exemplo de snippet de conteúdo indexado...
                        </p>
                        <div class="result-meta">
                            <span>Servido a partir de Barrels distribuídos</span>
                            <a href="#"
                               th:href="@{'/links?url=' + ${r.url}}">
                                Ver páginas que apontam para este URL
                            </a>
                        </div>
                    </a>
                </div>

                <!-- Pagination -->
                <div class="pagination-wrap"
                     th:if="${totalPages > 1}">
                    <nav aria-label="Paginação de resultados">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item"
                                th:classappend="${currentPage == 0} ? ' disabled'">
                                <a class="page-link"
                                   th:href="@{/search(q=${query}, page=${currentPage - 1})}">
                                    Anterior
                                </a>
                            </li>
                            <li class="page-item"
                                th:each="p : ${#numbers.sequence(0, totalPages - 1)}"
                                th:classappend="${p == currentPage} ? ' active'">
                                <a class="page-link"
                                   th:text="${p + 1}"
                                   th:href="@{/search(q=${query}, page=${p})}">
                                    1
                                </a>
                            </li>
                            <li class="page-item"
                                th:classappend="${currentPage == totalPages - 1} ? ' disabled'">
                                <a class="page-link"
                                   th:href="@{/search(q=${query}, page=${currentPage + 1})}">
                                    Seguinte
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>

                <!-- AI analysis -->
                <div class="mt-3"
                     th:if="${aiAnalysis != null}">
                    <div class="search-subtitle mb-1">Análise da pesquisa</div>
                    <p style="font-size: 0.82rem; color: var(--text-muted);" th:text="${aiAnalysis}"></p>
                </div>
            </section>
        </section>

        <!-- SIDE STATS PANEL -->
        <aside class="side-panel">

            <section class="side-card">
                <div class="side-title">Estado do cluster</div>
                <ul class="side-list">
                    <li>Downloaders ativos: <span id="stats-downloaders" class="stat-number">-</span></li>
                    <li>Barrels ativos: <span id="stats-barrels" class="stat-number">-</span></li>
                    <li>URLs na fila: <span id="stats-queue-size" class="stat-number">-</span></li>
                </ul>
                <div class="side-footer">
                    Atualizado em tempo real via WebSocket.
                </div>
            </section>

            <section class="side-card">
                <div class="side-title">Top 10 pesquisas</div>
                <ol class="side-list" id="stats-top-queries">
                    <!-- preenchido via WebSocket -->
                </ol>
            </section>

            <section class="side-card">
                <div class="side-title">Latência dos Barrels</div>
                <ul class="side-list" id="stats-latencies">
                    <!-- preenchido via WebSocket -->
                </ul>
            </section>

        </aside>
    </main>
</div>

<!-- JS Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- WebSocket / SockJS / STOMP -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    // Mesma lógica de stats em tempo real, só que agora ligado aos novos IDs
    (function () {
        let socket = new SockJS('/ws-stats');
        let stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, function () {
            stompClient.subscribe('/topic/stats', function (message) {
                const data = JSON.parse(message.body);

                document.getElementById('stats-downloaders').textContent = data.downloadersActive;
                document.getElementById('stats-barrels').textContent = data.barrelsActive;
                document.getElementById('stats-queue-size').textContent = data.queueSize;

                const topQueriesElem = document.getElementById('stats-top-queries');
                topQueriesElem.innerHTML = '';
                (data.topQueries || []).forEach(function (q) {
                    const li = document.createElement('li');
                    li.textContent = q;
                    topQueriesElem.appendChild(li);
                });

                const latenciesElem = document.getElementById('stats-latencies');
                latenciesElem.innerHTML = '';
                (data.barrelLatencies || []).forEach(function (b) {
                    const li = document.createElement('li');
                    li.textContent = b.barrelId + ': ' + b.avgMs + ' ms';
                    latenciesElem.appendChild(li);
                });
            });
        });
    })();
</script>

</body>
</html>
